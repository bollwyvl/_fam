#!/usr/bin/env bash
set -eux

mamba env update --file mamba.yml --prefix ${NB_PYTHON_PREFIX}

python -m pidgy kernel install

python -m pip check

jupyter serverextension enable --py jupyter_videochat --sys-prefix

jupyter labextension install $(cat labex.txt) --no-build --debug

# this is a fork of https://github.com/QuantStack/jupyterlab-drawio
git clone https://github.com/bollwyvl/jupyterlab-drawio

pushd jupyterlab-drawio
  git checkout add-drawio-export
  git submodule update --init
  jupyter nbconvert --execute scripts/Drawio_Update.ipynb
  jlpm
  jlpm build
  npm pack
  jupyter labextension install \
      ./jupyterlab-drawio-*.tgz \
      --no-build \
      --debug
popd

git clone https://github.com/bollwyvl/jupyter-videochat.git

pushd jupyter-videochat
  git checkout add-url-router
  jlpm
  jlpm build
  npm pack
  jupyter labextension install \
      ./jupyterlab-videochat-*.tgz \
      --no-build \
      --debug
popd

git clone https://github.com/bollwyvl/jupyterlab-outsource.git

pushd jupyterlab-outsource
  git checkout upgrade-jlab2
  jlpm --ignore-optional || jlpm || echo "well, let's try anyway"
  jlpm bootstrap
  jlpm lab:link
popd

git clone https://github.com/bollwyvl/wxyz

pushd wxyz
  git checkout jlab2
  doit -n4 setup_py_dev ts
  jupyter labextension install --debug --no-build $(find src/ts | grep tgz)
popd

jupyter labextension list

mkdir .tmp

pushd .tmp
  jupyter lab build --debug --dev-build=False --minimize=False || echo "didn't work, continuing anyway"
popd

jupyter labextension list
